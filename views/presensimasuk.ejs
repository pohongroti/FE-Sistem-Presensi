<!-- Ini Page PresensiMasuk.ejs -->
<html>
    <head>
        <title>Pegawai | Presensi Masuk</title>
        <link rel="stylesheet" href="/user/css/templatepresensi.css"/>
        <!--Import Library/API Maps Mapboxgl-->
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
        <!-- Library untuk menghitung jarak antar koordinat-->
        <script src="https://npmcdn.com/@turf/turf@5.1.6/turf.min.js"></script>

    </head>
    <body>
        <div class="container">
            <div class="logo">
                <a href="/user/beranda"><img alt="logo sekolah" width="100px" src="/user/gambar/logo-smk.jpg"/></a>
            <h4><label>PRESENSI MASUK PEGAWAI</label></h4>
            </div>
            <form action="/user/addpresensimasuk" method="POST">
                <div class="input">
                    <label><b>PROFIL PEGAWAI</b></label>
                    <table border="0" bgcolor="grey">
                        <% if(pegawai.length!=0){ 
                            var i = 1;
                            pegawai.forEach(function(datain){
                         %>
                        <tr>
                            <td>ID PEGAWAI</td><td>: <b><u><%= datain.idpegawai %></u></b></td>
                        </tr>
                        <tr>
                            <td>NAMA PEGAWAI</td><td>: <b><u><%= datain.namapegawai %></u></b></td>
                        </tr>
                        <tr>
                            <td>JABATAN PEGAWAI</td><td>: <b><u><%= datain.jabatanpegawai %></u></b></td>
                        </tr>
                        <% i++; })} %>
                    </table>

                </div>
                <div class="input">
                    <label>HARI, WAKTU DETAIL</label>
                    <table border="0" bgcolor="grey">
                        <tr>
                            <th> <span id="tglwaktuin"></span> </th>
                        </tr>
                    </table>
                    
                <script>
                      var waktu = new Date();
                          var tahun = waktu.getFullYear();
                          var bulan = waktu.getMonth();
                          var tgl = waktu.getDate();
                          var hari = waktu.getDay();
                          var jam = waktu.getHours();
                          var menit = waktu.getMinutes();
                          var sekon = waktu.getSeconds();
                          switch(bulan){
                                  case 0:
                                    bulan="JANUARI";
                                    break;
                                  case 1:
                                      bulan="FEBRUARI";
                                      break;
                                  case 2:
                                      bulan="MARET";
                                      break;
                                  case 3:
                                      bulan="APRIL";
                                      break;
                                  case 4:
                                      bulan="MEI";
                                      break;
                                  case 5:
                                      bulan="JUNI";
                                      break;
                                  case 6:
                                      bulan="JULI";
                                      break;
                                  case 7:
                                      bulan="AGUSTUS";
                                      break;
                                  case 8:
                                      bulan="SEPTEMBER";
                                      break;
                                  case 9:
                                      bulan="OKTOBER";
                                      break;
                                  case 10:
                                      bulan="NOPEMBER";
                                      break;
                                  case 11:
                                      bulan="DESEMBER";
                                      break;
                                  default: 
                                 }
  
                                 switch(hari){
                                    case 0:
                                      hari="AHAD";
                                      break;
                                  case 1:
                                      hari="SENIN";
                                      break;
                                  case 2:
                                      hari="SELASA";
                                      break;
                                  case 3:
                                      hari="RABU";
                                      break;
                                  case 4:
                                      hari="KAMIS";
                                      break;
                                  case 5:
                                      hari="JUMAT";
                                      break;
                                  case 6:
                                      hari="SABTU";
                                      break;
                                  default:   
                                  }
  
                                  jam = ("0" + jam).slice(-2);
                                  menit = ("0" + menit).slice(-2);
                                  sekon = ("0" + sekon).slice(-2);
  
                                  dwaktu= " "+hari+", "+tgl+" "+bulan+" "+tahun+" "+jam+":"+menit+":"+sekon+" WIB";
  
                              document.getElementById("tglwaktuin").innerHTML = dwaktu.toLocaleString();
                </script>
                </div>
                <div class="input">
                    <label>SISTEM KERJA [Harus pilih salah satu]</label>
                    <table border="0" bgcolor="grey">
                        <tr>
                            <th> <input value="WFH" name="sistemkerja" type="radio" />WFH </th>
                            <td>||</td>
                            <th> <input value="WFO" name="sistemkerja" type="radio" checked="checked"/>WFO </th>
                        </tr>
                    </table>
                </div>
                

                <div class="input">
                    <label>UPLOAD FOTO PEGAWAI ||
                    <input id="foto" name="foto" type="file"/>
                    </label>
                </div>
                
                <div class="input">
                <label>TITIK LOKASI PEGAWAI</label>
                <div id="map"></div> 
                    <input id="longitude" name="longitude" hidden="active" type="text" />
                    <input id="latitude" name="latitude"  hidden="active" type="text" />
                </div>
                
                <button class="button-full" type="submit">PRESENSI</button>
            </form>
        </div>
        <script>
            // Setting Akses Token
            mapboxgl.accessToken = 'pk.eyJ1IjoicG9ob25ncm90aSIsImEiOiJja2xkd29pcnQxZWtnMnVxZTRuZ2FoMGNuIn0.FfqcsxR2VxqPgtj0ZuHtUw';
            // Inisialisasi Map
            var map = new mapboxgl.Map({
            container: 'map',//
            style: 'mapbox://styles/mapbox/streets-v11',
            center:[110.9503402,-7.5902476],
            zoom: 15
            });
            //Label nama lokasi
            var popup= new mapboxgl.Popup().setText("SMK Negeri 2 Karanganyar").addTo(map);
            //Penanda lokasi warna biru
            var marker = new mapboxgl.Marker()
            .setLngLat([110.9503402,-7.5902476])
            .addTo(map).setPopup(popup);
            // fungsi geolokasi untuk mengambil lokasi saat ini
            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition);
                } else {
                    alert("Geolokasi tidak mendukung pada Smartphone Anda atau hidupkan GPS Anda");

                }
            };

             function showPosition(position) {
                 //console.log(position.coords.longitude,position.coords.latitude);
                document.getElementById('longitude').value = position.coords.longitude;
                document.getElementById('latitude').value = position.coords.latitude;
                //==================================================================
                //Tahap-tahap Hitung Rumus Haversine
                //1. Menjabarkan titik koordinat dalam angka desimal
                    var lon1=position.coords.longitude;
                    var lat1=position.coords.latitude;
                    var lon2=110.9503402;
                    var lat2=-7.5902476;
                
                //2. Menjabarkan titik koordinat dalam bilangan radian
                    var r=0.017453293;
                    var rlon1=lon1*0.017453293;
                    var rlat1=lat1*0.017453293;
                    var rlon2=lon2*0.017453293;
                    var rlat2=lat2*0.017453293;
                
                 //3. Menghitung jarak dengan rumus haversine
                 //Rumus mencari X
                    var x=((rlon2)-(rlon1))*(Math.cos(((rlat1)+(rlat2))/2));
                    var a=((rlon2)-(rlon1));
                    var b=(Math.cos(((rlat1)+(rlat2))/2));
                //Rumus mencari Y
                    var y=((rlat2)-(rlat1));
                //Rumus mencari Jarak(Distance/d)
                    var rb=6371;
                    var jarak=(rb)*(Math.sqrt((x*x)+(y*y)));
                    var jarakm=(1000)*(rb)*(Math.sqrt((x*x)+(y*y)));
                //74.78446911404285
                //==================================================================
		var from = turf.point([110.9503402,-7.5902476]);
                var to = turf.point([position.coords.longitude, position.coords.latitude]);
                var distance = turf.distance(from,to, {units: 'kilometers'});
                //==================================================================
                if(jarak>1){
                    //alert("lon1="+lon1+",lat1="+lat1+",rad-lon2="+rlon2+",rad-lon1="+rlon1+",lon2-lon1="+a+", cosnya="+b+", rumus X="+x+", rumus Y="+y+", hasil akhir="+jarak);
                    alert(jarak+"km, atau "+ jarakm +" m, Anda tidak bisa presensi karena melebihi jarak yang ditetapkan, pada titik koordinat Lintang="+position.coords.longitude+", Dan Bujur="+position.coords.latitude);
                } else{
                    alert("Anda bisa presensi dengan jarak="+ jarak +" km, atau "+ jarakm +" m, pada titik koordinat Lintang="+position.coords.longitude+", Dan Bujur="+position.coords.latitude);
                }
            }; 
            // listener / fungsi untuk merespon otomatis ketika suatu sudah selesai atau akan di kerjakan
            document.addEventListener('DOMContentLoaded', function(){
                getLocation();
            });

            </script>
    </body>
</html>